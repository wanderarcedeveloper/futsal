<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Pelada PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .draggable-item { cursor: grab; touch-action: none; }
        .draggable-item:active { cursor: grabbing; }
        .font-mono-nums { font-variant-numeric: tabular-nums; }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #4b5563; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen pb-10 text-xs">

<div id="app" class="container mx-auto p-2 max-w-7xl">
    
    <header class="mb-4 bg-gray-800 p-3 rounded-xl shadow-lg border border-gray-700">
        <div class="flex flex-wrap justify-between items-center gap-3">
            <div>
                <h1 class="text-xl font-extrabold text-emerald-400 flex items-center gap-2">
                    <i class="ph ph-soccer-ball"></i> Controle de Pelada
                </h1>
                <p class="text-[10px] text-gray-400">Ordem da lista (Sem sorteio)</p>
            </div>
            
            <div class="flex flex-wrap gap-2 text-xs">
                <div class="flex flex-col">
                    <label class="text-gray-500 text-[10px] font-bold uppercase">Jogadores/Time</label>
                    <select v-model.number="config.playersPerTeam" class="bg-gray-700 border border-gray-600 rounded px-2 py-0.5 text-white focus:border-emerald-500 outline-none text-xs">
                        <option :value="5">5 (Futsal)</option>
                        <option :value="6">6 (Society)</option>
                        <option :value="7">7 (Society)</option>
                        <option :value="11">11 (Campo)</option>
                    </select>
                </div>
                <div class="flex flex-col">
                    <label class="text-gray-500 text-[10px] font-bold uppercase">Modo</label>
                    <span class="font-bold text-emerald-400 text-xs">{{ status.isFirstMatch ? '1ª Partida (10min)' : 'Normal (7min)' }}</span>
                </div>
                <button @click="resetAll" class="bg-red-900/50 hover:bg-red-800 text-red-200 px-2 py-0.5 rounded border border-red-700 text-[10px] ml-auto h-8 self-end">
                    Limpar
                </button>
            </div>
        </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-4">
        
        <section class="lg:col-span-3 space-y-3">
            <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden">
                <div @click="ui.showRegister = !ui.showRegister" class="p-2 bg-gray-750 cursor-pointer flex justify-between items-center hover:bg-gray-700">
                    <h2 class="font-bold text-gray-300 flex items-center gap-2 text-sm"><i class="ph ph-users"></i> Lista de Presença</h2>
                    <i class="ph" :class="ui.showRegister ? 'ph-caret-up' : 'ph-caret-down'"></i>
                </div>
                
                <div v-show="ui.showRegister" class="p-2 space-y-2">
                    <textarea v-model="input.goalkeepers" placeholder="Goleiros (um por linha)..." class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-[11px] h-16 focus:ring-1 focus:ring-emerald-500 outline-none"></textarea>
                    <textarea v-model="input.lines" placeholder="Linha (um por linha)..." class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-[11px] h-20 focus:ring-1 focus:ring-emerald-500 outline-none"></textarea>
                    <button @click="addPlayers" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-1.5 rounded text-xs transition">Adicionar</button>
                </div>

                <div class="max-h-[350px] overflow-y-auto p-2 border-t border-gray-700">
                    <div class="flex justify-between text-[10px] text-gray-400 px-2 mb-1">
                        <span>Nome</span>
                        <span>Pagou?</span>
                    </div>
                    <ul class="space-y-1">
                        <li v-for="(p, idx) in allPlayers" :key="p.id" class="flex items-center justify-between bg-gray-900 p-1.5 rounded border border-gray-700 group">
                            <div class="flex items-center gap-2">
                                <span class="text-[9px] text-gray-500 w-3">{{ idx + 1 }}</span>
                                <span class="w-1.5 h-1.5 rounded-full" :class="p.role === 'GK' ? 'bg-yellow-500' : 'bg-blue-500'"></span>
                                <span class="text-xs font-medium truncate w-24" :class="{'opacity-50': !p.paid}">{{ p.name }}</span>
                            </div>
                            <input type="checkbox" v-model="p.paid" class="w-3.5 h-3.5 accent-emerald-500 cursor-pointer">
                        </li>
                    </ul>
                    <div v-if="allPlayers.length > 0" class="mt-2 pt-2 border-t border-gray-700 text-center">
                        <button @click="generateInitialTeams" class="bg-blue-600 hover:bg-blue-500 text-white w-full py-1.5 rounded font-bold text-xs flex items-center justify-center gap-2 shadow-lg">
                            <i class="ph ph-list-numbers"></i> Gerar pela Ordem
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <section class="lg:col-span-6 flex flex-col gap-3">
            
            <div class="bg-gray-800 rounded-xl border-2 border-emerald-500/30 shadow-xl overflow-hidden relative">
                <div class="absolute top-0 left-0 w-full h-0.5 bg-gradient-to-r from-emerald-500 via-yellow-500 to-emerald-500 opacity-50"></div>
                
                <div class="p-3 grid grid-cols-3 items-center text-center relative z-10">
                    <div class="flex flex-col items-center">
                        <h3 class="font-bold text-emerald-400 mb-1 tracking-wider text-xs">TIME A</h3>
                        <div class="flex items-center gap-1 bg-gray-900 rounded p-0.5 border border-gray-700">
                            <button @click="adjustScore('A', -1)" class="w-6 h-6 hover:bg-gray-700 rounded text-gray-400 flex items-center justify-center"><i class="ph ph-minus"></i></button>
                            <span class="text-2xl font-mono-nums font-bold w-8 text-center">{{ match.scoreA }}</span>
                            <button @click="adjustScore('A', 1)" class="w-6 h-6 hover:bg-emerald-900 rounded text-emerald-400 flex items-center justify-center"><i class="ph ph-plus"></i></button>
                        </div>
                    </div>

                    <div class="flex flex-col items-center justify-center">
                        <div class="text-5xl font-mono-nums font-bold tracking-widest mb-1 transition-colors leading-none" :class="{'text-red-500 animate-pulse': match.timeLeft < 60 && match.timeLeft > 0, 'text-gray-100': match.timeLeft >= 60}">
                            {{ formattedTime }}
                        </div>
                        <div class="flex gap-2 mb-1">
                            <button @click="toggleTimer" class="w-8 h-8 rounded-full flex items-center justify-center text-white transition transform hover:scale-105 shadow-lg" :class="match.timerRunning ? 'bg-yellow-600' : 'bg-green-600'">
                                <i class="ph" :class="match.timerRunning ? 'ph-pause' : 'ph-play'"></i>
                            </button>
                            <button @click="resetTimer(false)" class="w-8 h-8 rounded-full bg-gray-700 hover:bg-gray-600 flex items-center justify-center text-gray-300">
                                <i class="ph ph-arrow-counter-clockwise"></i>
                            </button>
                        </div>
                        <div class="text-[9px] uppercase font-bold text-gray-500 tracking-widest">
                            {{ status.isFirstMatch ? 'Meta: 3 Gols' : 'Meta: 2 Gols' }}
                        </div>
                    </div>

                    <div class="flex flex-col items-center">
                        <h3 class="font-bold text-red-400 mb-1 tracking-wider text-xs">TIME B</h3>
                        <div class="flex items-center gap-1 bg-gray-900 rounded p-0.5 border border-gray-700">
                            <button @click="adjustScore('B', -1)" class="w-6 h-6 hover:bg-gray-700 rounded text-gray-400 flex items-center justify-center"><i class="ph ph-minus"></i></button>
                            <span class="text-2xl font-mono-nums font-bold w-8 text-center">{{ match.scoreB }}</span>
                            <button @click="adjustScore('B', 1)" class="w-6 h-6 hover:bg-red-900 rounded text-red-400 flex items-center justify-center"><i class="ph ph-plus"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3 h-full">
                <div class="bg-gray-800/50 border border-emerald-500/20 rounded-lg flex flex-col" 
                     @dragover.prevent @drop="onDrop($event, 'teamA')">
                    <div class="bg-emerald-900/20 p-1.5 border-b border-emerald-500/20 text-center">
                        <span class="text-[10px] font-bold text-emerald-500 uppercase">Em Campo (A)</span>
                    </div>
                    <div class="p-1.5 flex-1 min-h-[150px] space-y-1">
                        <player-card v-for="p in match.teamA" :key="p.id" :player="p" @dragstart="onDragStart($event, p, 'teamA')"></player-card>
                    </div>
                </div>

                <div class="bg-gray-800/50 border border-red-500/20 rounded-lg flex flex-col"
                     @dragover.prevent @drop="onDrop($event, 'teamB')">
                    <div class="bg-red-900/20 p-1.5 border-b border-red-500/20 text-center">
                        <span class="text-[10px] font-bold text-red-500 uppercase">Em Campo (B)</span>
                    </div>
                    <div class="p-1.5 flex-1 min-h-[150px] space-y-1">
                        <player-card v-for="p in match.teamB" :key="p.id" :player="p" @dragstart="onDragStart($event, p, 'teamB')"></player-card>
                    </div>
                </div>
            </div>

            <div class="bg-gray-800 p-3 rounded-xl border border-gray-700 flex flex-col gap-2 shadow-lg">
                <div class="flex justify-between items-center px-1">
                    <span class="text-xs text-gray-400">Status:</span>
                    <span class="text-[10px] font-mono text-gray-500" v-if="status.waitingTeamsCount >= 2">Empate = remove ambos</span>
                </div>
                <button @click="endMatch" class="w-full bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-500 hover:to-red-500 text-white font-bold py-2.5 rounded-lg shadow-lg flex items-center justify-center gap-2 text-sm transition transform active:scale-95">
                    <i class="ph ph-whistle"></i> Encerrar & Rotacionar
                </button>
            </div>

        </section>

        <section class="lg:col-span-3 space-y-3 flex flex-col">
            
            <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden flex-shrink-0">
                <div class="p-1.5 bg-gray-750 border-b border-gray-700 text-center">
                    <h3 class="text-xs font-bold text-blue-400">Próximos</h3>
                </div>
                
                <div class="p-1.5 space-y-1.5">
                    <div class="bg-gray-900/50 rounded border border-gray-700/50" @dragover.prevent @drop="onDrop($event, 'nextTeam1')">
                        <div class="px-2 py-0.5 text-[9px] font-bold text-gray-500 uppercase flex justify-between">
                            <span>Próximo 1</span>
                            <span>{{ nextTeams.team1.length }}/{{config.playersPerTeam}}</span>
                        </div>
                        <div class="p-1 min-h-[50px] space-y-1">
                            <player-card v-for="p in nextTeams.team1" :key="p.id" :player="p" :mini="true" @dragstart="onDragStart($event, p, 'nextTeam1')"></player-card>
                            <div v-if="nextTeams.team1.length === 0" class="text-[9px] text-center text-gray-600 py-1 italic">Vazio</div>
                        </div>
                    </div>

                    <div class="bg-gray-900/50 rounded border border-gray-700/50" v-if="queue.length > config.playersPerTeam" @dragover.prevent @drop="onDrop($event, 'nextTeam2')">
                        <div class="px-2 py-0.5 text-[9px] font-bold text-gray-500 uppercase flex justify-between">
                            <span>Próximo 2</span>
                            <span>{{ nextTeams.team2.length }}/{{config.playersPerTeam}}</span>
                        </div>
                        <div class="p-1 min-h-[50px] space-y-1">
                            <player-card v-for="p in nextTeams.team2" :key="p.id" :player="p" :mini="true" @dragstart="onDragStart($event, p, 'nextTeam2')"></player-card>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden flex-1 flex flex-col min-h-[180px]">
                <div class="p-2 bg-gray-750 border-b border-gray-700 flex justify-between items-center">
                    <h3 class="text-xs font-bold text-yellow-400">Fila de Espera</h3>
                    <span class="bg-gray-900 text-[10px] px-1.5 rounded text-gray-400">{{ queue.length }}</span>
                </div>
                <div class="flex-1 p-1.5 bg-gray-900/30 overflow-y-auto" @dragover.prevent @drop="onDrop($event, 'queue')">
                    <div class="space-y-1 min-h-full">
                        <player-card v-for="(p, index) in queue" :key="p.id" :player="p" :index="index + 1" @dragstart="onDragStart($event, p, 'queue')"></player-card>
                        <div v-if="queue.length === 0" class="text-center text-gray-600 text-xs py-8 italic">
                            Ninguém na espera
                        </div>
                    </div>
                </div>
            </div>

        </section>
    </div>

</div>

<script type="text/x-template" id="player-card-template">
    <div 
        class="draggable-item bg-gray-700 hover:bg-gray-600 rounded flex justify-between items-center shadow border-l-[3px] select-none transition group"
        :class="[
            player.role === 'GK' ? 'border-yellow-500' : 'border-blue-500',
            mini ? 'p-0.5' : 'py-1 px-2'
        ]"
        draggable="true"
    >
        <div class="flex items-center gap-2 overflow-hidden">
            <span v-if="index" class="text-[9px] font-mono bg-gray-800 w-3.5 h-3.5 flex items-center justify-center rounded text-gray-400">{{ index }}</span>
            <div class="flex flex-col truncate">
                <span class="font-bold text-gray-200 truncate leading-tight" :class="mini ? 'text-[10px]' : 'text-xs'">{{ player.name }}</span>
                <span v-if="!mini && player.role === 'GK'" class="text-[8px] text-yellow-500 uppercase font-bold leading-none mt-[1px]">Goleiro</span>
            </div>
        </div>
        <i v-if="!mini" class="ph ph-dots-six-vertical text-gray-500 text-xs group-hover:text-gray-300"></i>
    </div>
</script>

<script>
    const { createApp, reactive, ref, computed, onMounted } = Vue;

    const app = createApp({
        setup() {
            // --- ESTADO ---
            const config = reactive({
                playersPerTeam: 5, 
                timeFirstMatch: 10, 
                timeNormalMatch: 7,
                goalLimitFirst: 3,
                goalLimitNormal: 2
            });

            const status = reactive({
                isFirstMatch: true,
                lastUpdate: Date.now(),
                waitingTeamsCount: 0
            });

            const ui = reactive({ showRegister: true });
            const input = reactive({ goalkeepers: '', lines: '' });
            
            const allPlayers = ref([]); 
            const match = reactive({ teamA: [], teamB: [], scoreA: 0, scoreB: 0, timeLeft: 600, timerRunning: false });
            const nextTeams = reactive({ team1: [], team2: [] });
            const queue = ref([]);

            let timerInterval = null;
            let draggedItem = null;
            let sourceList = null;

            // --- COMPUTEDS ---
            const formattedTime = computed(() => {
                const m = Math.floor(match.timeLeft / 60).toString().padStart(2, '0');
                const s = (match.timeLeft % 60).toString().padStart(2, '0');
                return `${m}:${s}`;
            });

            // --- PERSISTÊNCIA ---
            const saveData = () => {
                const data = {
                    config, status, allPlayers: allPlayers.value, 
                    match, nextTeams, queue: queue.value,
                    timestamp: Date.now()
                };
                localStorage.setItem('futebolAppData', JSON.stringify(data));
            };

            const loadData = () => {
                const saved = localStorage.getItem('futebolAppData');
                if (saved) {
                    const data = JSON.parse(saved);
                    if (Date.now() - data.timestamp < 24 * 60 * 60 * 1000) {
                        Object.assign(config, data.config);
                        Object.assign(status, data.status);
                        Object.assign(match, data.match);
                        Object.assign(nextTeams, data.nextTeams);
                        allPlayers.value = data.allPlayers;
                        queue.value = data.queue;
                        match.timerRunning = false;
                    } else {
                        localStorage.removeItem('futebolAppData');
                    }
                }
            };

            // --- AÇÕES ---
            const resetAll = () => {
                if(confirm("Limpar todos os dados?")){
                    localStorage.removeItem('futebolAppData');
                    location.reload();
                }
            };

            const addPlayers = () => {
                const process = (text, role) => {
                    if(!text) return;
                    text.split('\n').forEach(line => {
                        const name = line.trim();
                        if(name) {
                            allPlayers.value.push({
                                id: Date.now() + Math.random(),
                                name, role, paid: false
                            });
                        }
                    });
                };
                process(input.goalkeepers, 'GK');
                process(input.lines, 'LINE');
                input.goalkeepers = '';
                input.lines = '';
                saveData();
            };

            // === NOVA LÓGICA DE GERAÇÃO (FIFO / ORDEM DA LISTA) ===
            const generateInitialTeams = () => {
                const paid = allPlayers.value.filter(p => p.paid);
                
                // Separa SEM embaralhar (mantém ordem de inserção)
                let gks = paid.filter(p => p.role === 'GK');
                let lines = paid.filter(p => p.role === 'LINE');

                // Função auxiliar que preenche o time passado como argumento
                const fillTeam = (targetArray) => {
                    // Tenta pegar 1 Goleiro do topo da lista
                    if(gks.length > 0) {
                        targetArray.push(gks.shift());
                    }
                    // Completa com linha até o limite
                    while(targetArray.length < config.playersPerTeam && lines.length > 0) {
                        targetArray.push(lines.shift());
                    }
                };

                // Limpa estado atual
                match.teamA = []; match.teamB = [];
                nextTeams.team1 = []; nextTeams.team2 = [];
                queue.value = [];

                // Aplica lógica sequencial
                fillTeam(match.teamA);
                fillTeam(match.teamB);
                fillTeam(nextTeams.team1);
                fillTeam(nextTeams.team2);

                // O que sobrou vai para a fila (Goleiros primeiro, depois Linha)
                queue.value = [...gks, ...lines];

                resetTimer(true);
                ui.showRegister = false;
                saveData();
            };

            // Timer
            const toggleTimer = () => {
                match.timerRunning = !match.timerRunning;
                if (match.timerRunning) {
                    timerInterval = setInterval(() => {
                        if (match.timeLeft > 0) {
                            match.timeLeft--;
                            saveData(); 
                        } else {
                            match.timerRunning = false;
                            clearInterval(timerInterval);
                            alert("Tempo Esgotado!");
                        }
                    }, 1000);
                } else {
                    clearInterval(timerInterval);
                    saveData();
                }
            };

            const resetTimer = (isFirst) => {
                clearInterval(timerInterval);
                match.timerRunning = false;
                status.isFirstMatch = isFirst;
                match.timeLeft = (isFirst ? config.timeFirstMatch : config.timeNormalMatch) * 60;
                match.scoreA = 0;
                match.scoreB = 0;
                saveData();
            };

            const adjustScore = (team, delta) => {
                if(team === 'A') match.scoreA = Math.max(0, match.scoreA + delta);
                else match.scoreB = Math.max(0, match.scoreB + delta);
                saveData();
            };

            // Rotação
            const endMatch = () => {
                if(!confirm("Encerrar e rotacionar?")) return;

                clearInterval(timerInterval);
                match.timerRunning = false;

                let winner = null; 
                if (match.scoreA > match.scoreB) winner = 'A';
                else if (match.scoreB > match.scoreA) winner = 'B';
                else winner = 'DRAW';

                const teamA_Players = [...match.teamA];
                const teamB_Players = [...match.teamB];
                
                const next1Ready = nextTeams.team1.length >= (config.playersPerTeam - 1);
                const next2Ready = nextTeams.team2.length >= (config.playersPerTeam - 1);
                const waitingTeams = (next1Ready ? 1 : 0) + (next2Ready ? 1 : 0);
                status.waitingTeamsCount = waitingTeams;

                const sendToQueue = (players) => {
                    players.forEach(p => queue.value.push(p));
                };

                if (winner === 'DRAW') {
                    if (waitingTeams >= 2) {
                        sendToQueue(teamA_Players);
                        sendToQueue(teamB_Players);
                        match.teamA = []; 
                        match.teamB = [];
                    } else {
                        sendToQueue(teamB_Players);
                        match.teamB = [];
                    }
                } else {
                    const losers = winner === 'A' ? teamB_Players : teamA_Players;
                    const winners = winner === 'A' ? teamA_Players : teamB_Players;

                    sendToQueue(losers);
                    match.teamA = winners;
                    match.teamB = []; 
                }

                const getNextChallenger = () => {
                    let challenger = [];
                    if (nextTeams.team1.length > 0) {
                        challenger = [...nextTeams.team1];
                        nextTeams.team1 = []; 
                        if (nextTeams.team2.length > 0) {
                            nextTeams.team1 = [...nextTeams.team2];
                            nextTeams.team2 = [];
                        }
                    } else {
                        while (challenger.length < config.playersPerTeam && queue.value.length > 0) {
                            challenger.push(queue.value.shift());
                        }
                    }
                    return challenger;
                };

                if (match.teamA.length === 0) match.teamA = getNextChallenger();
                if (match.teamB.length === 0) match.teamB = getNextChallenger();

                while(match.teamA.length < config.playersPerTeam && queue.value.length > 0) match.teamA.push(queue.value.shift());
                while(match.teamB.length < config.playersPerTeam && queue.value.length > 0) match.teamB.push(queue.value.shift());

                resetTimer(false); 
                saveData();
            };

            // Drag & Drop
            const onDragStart = (evt, player, listName) => {
                draggedItem = player;
                sourceList = listName;
                evt.dataTransfer.effectAllowed = 'move';
            };

            const onDrop = (evt, targetList) => {
                if (!draggedItem || sourceList === targetList) return;

                const removeFromList = (listName) => {
                    if (listName === 'teamA') match.teamA = match.teamA.filter(p => p.id !== draggedItem.id);
                    else if (listName === 'teamB') match.teamB = match.teamB.filter(p => p.id !== draggedItem.id);
                    else if (listName === 'nextTeam1') nextTeams.team1 = nextTeams.team1.filter(p => p.id !== draggedItem.id);
                    else if (listName === 'nextTeam2') nextTeams.team2 = nextTeams.team2.filter(p => p.id !== draggedItem.id);
                    else if (listName === 'queue') queue.value = queue.value.filter(p => p.id !== draggedItem.id);
                };
                removeFromList(sourceList);

                if (targetList === 'queue') queue.value.push(draggedItem); 
                else if (targetList === 'teamA') match.teamA.push(draggedItem);
                else if (targetList === 'teamB') match.teamB.push(draggedItem);
                else if (targetList === 'nextTeam1') nextTeams.team1.push(draggedItem);
                else if (targetList === 'nextTeam2') nextTeams.team2.push(draggedItem);

                draggedItem = null;
                saveData();
            };

            onMounted(() => {
                loadData();
            });

            return {
                config, status, ui, input, allPlayers, match, nextTeams, queue,
                formattedTime,
                addPlayers, resetAll, generateInitialTeams,
                toggleTimer, resetTimer, adjustScore, endMatch,
                onDragStart, onDrop
            };
        }
    });

    app.component('player-card', {
        props: ['player', 'index', 'mini'],
        template: '#player-card-template'
    });

    app.mount('#app');
</script>
</body>
</html>
